name: Deploy Staging ðŸš€
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Deploy to staging via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST_STAGING }}
          username: ${{ secrets.SSH_USER_NAME_STAGING }}
          key: ${{ secrets.SSH_PRIVATE_KEY_STAGING }}
          script: |
            set -e
            cd ${{ secrets.APP_STG_PATH }} || git clone ${{ secrets.GIT_URL }} ${{ secrets.APP_STG_PATH }}
            git -C ${{ secrets.APP_STG_PATH }} fetch --all
            git -C ${{ secrets.APP_STG_PATH }} reset --hard origin/main
            # write .env on server staging from secrets
            cat > ${{ secrets.APP_STG_PATH }}/.env <<'EOF'
MINIO_STG_ENDPOINT=${{ secrets.MINIO_STG_ENDPOINT }}
MINIO_STG_ACCESS_KEY=${{ secrets.MINIO_STG_ACCESS_KEY }}
MINIO_STG_SECRET_KEY=${{ secrets.MINIO_STG_SECRET_KEY }}
APP_STG_PORT=${{ secrets.APP_STG_PORT }}
EOF
            cd ${{ secrets.APP_STG_PATH }}
            sudo docker compose pull || true
            sudo docker compose up --build --detach pacmusic-stg
            sleep 5
            curl -f http://localhost:${{ secrets.APP_STG_PORT }}
